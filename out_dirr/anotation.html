<!DOCTYPE html>                        
<html>
<head>
    <title>Uploading folders in any browser</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<p>Directory: <input type="file" webkitdirectory mozdirectory /></p>
<div class="main-content" style="width: 100%">
	<div style="display: inline-block; width: 65%">
		<image id="main-img" style="width: 95%" /> 
	</div>
	<div style="display: inline-block; width: 30%">
		<textarea id="predict" style="width: 95%" rows="20"></textarea>
	</div>
</div>
<div class="footer" style="width: 100%; text-align: center;">
	<div style="display: inline-block; width: 65%">
		<div style="display: inline-block;"><button id="prev">Prev</button></div>
		<div style="display: inline-block;"><button id="next">Next</button></div>
	</div>
	<div style="display: inline-block; width: 30%">
		<div style="display: inline-block;"><button id="save">Save</button></div>
	</div>
</div>
<script type="text/javascript">
	var imgs = [];
	var dicts = [];
	let count = 0;
	let dict_count = 0;
	let global_content = null;
	var global_name = null;
	var change = false;
	var iptEls = document.querySelectorAll('input');
	[].forEach.call(iptEls, function(iptEl) {
	    iptEl.onchange = function(e) {
	    	const fileList = Array.from(this.files);
	        for (let file of fileList) {
	        	if (file.type.split('/')[0] == 'image') {
	        		imgs.push(file);
	        	} else {
	        		dicts.push(file);
	        	}
	        }
	        global_name = dicts[count].name;
	        $('#main-img').attr("src", imgs[count].webkitRelativePath);
			var reader = new FileReader();
    		dict_count = find_index(imgs[count].name.split('.')[0]);
    		reader.readAsText(dicts[dict_count], "UTF-8");
    		reader.onload = function (evt) {
    			global_content = evt.target.result;
		        $('#predict').val(evt.target.result);
		    }
	    };
	});
	function receivedText(e) {
      let lines = e.target.result;
      var newArr = JSON.parse(lines); 
    }
    function download() {
    	if (change) {
    		var pp = document.createElement('a');
			pp.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(global_content));
			pp.setAttribute('download', global_name);
			pp.click();
    	}
	}
	function find_index(name) {
		for (let i in dicts){
			if(dicts[i].name.split('.')[0] == name) {
				console.log(dicts[i]);
				return i;
			}
		}
		return -1;
	}
    $(document).ready(function(){
    	$('#prev').on('click', function() {
    		if (count >= 1) {
    			download();
    			count -= 1;
	    		global_name = dicts[count].name;
	    		$('#main-img').attr("src", imgs[count].webkitRelativePath);
				var reader = new FileReader();
	    		dict_count = find_index(imgs[count].name.split('.')[0]);
    			reader.readAsText(dicts[dict_count], "UTF-8");
	    		reader.onload = function (evt) {
	    			global_content = evt.target.result;
			        $('#predict').val(evt.target.result);
			    }
    		}
    	})
    	$('#next').on('click', function() {
    		if (count < imgs.length - 1) {
    			download();
    			count += 1;
	    		global_name = dicts[count].name;
	    		$('#main-img').attr("src", imgs[count].webkitRelativePath);
				var reader = new FileReader();
	    		dict_count = find_index(imgs[count].name.split('.')[0]);
    			reader.readAsText(dicts[dict_count], "UTF-8");
	    		reader.onload = function (evt) {
	    			global_content = evt.target.result;
			        $('#predict').val(evt.target.result);
			    }
    		}
    	})
    	$('#save').on('click', function(){
    		download()
    	})
    	$('#predict').on('keyup', function(){
    		global_content = $('#predict').val();
    		change = true;
    	})
    })

</script>
</body>
</html>